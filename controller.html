<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Websockets Using JavaScript MQTT Client - publish</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">
    </head>
    <body>
        <h1>Websockets MQTT Monitor</h1>
        <script type = "text/javascript"> </script>
        <div id="status">Connection Status: Not Connected</div>
        <div id="status_messages"></div>
        <p>
            <input type="button" id="OF" value="OF">
            &nbsp&nbsp&nbsp&nbsp&nbsp
            <input type="button" id="FF" value="FF">
            &nbsp&nbsp&nbsp&nbsp&nbsp
            <input type="button" id="FO" value="FO">
        </p>
        <p>
            <input type="button" id="RF" value="RF">
            &nbsp&nbsp&nbsp&nbsp&nbsp
            <input type="button" id="OO" value="OO">
            &nbsp&nbsp&nbsp&nbsp&nbsp
            <input type="button" id="FR" value="FR">
        </p>
        <p>
            <input type="button" id="OR" value="OR">
            &nbsp&nbsp&nbsp&nbsp&nbsp
            <input type="button" id="RR" value="RR">
            &nbsp&nbsp&nbsp&nbsp&nbsp
            <input type="button" id="RO" value="RO">
        </p>
    </body>
</html>



<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type = "text/javascript"></script>
<script type = "text/javascript">

    var connected_flag=0    
    var mqtt;
    var reconnectTimeout = 2000;
    var host="iot.eclipse.org";
    var port=443;
    var row=0;
    var out_msg="";
    var mcount=0;
    var iid;


    function onConnectionLost(){
      console.log("connection lost");
      document.getElementById("status").innerHTML = "Connection Status: Connection Lost";
      document.getElementById("status_messages").innerHTML ="Connection Lost";
      connected_flag=0;
    }

    function onFailure(message) {
      console.log("Failed");
      document.getElementById("status_messages").innerHTML = "Connection Failed- Retrying";
      setTimeout(MQTTconnect, reconnectTimeout);
    }
        
    function onConnected(recon,url){
      console.log(" in onConnected " +reconn);
    }

    function onConnect() {
      // Once a connection has been made, make a subscription and send a message.
      document.getElementById("status_messages").innerHTML ="Connected to "+host +" on port "+port;
      connected_flag=1;
      document.getElementById("status").innerHTML = "Connection Status: Connected";
      console.log("on Connect "+connected_flag);
    }

    function disconnect() {
      if (connected_flag==1)
      mqtt.disconnect();
    }

    function MQTTconnect() {
        document.getElementById("status_messages").innerHTML ="";
        document.getElementById("status_messages").innerHTML='connecting';
        mqtt = new Paho.MQTT.Client(host,port,"bb-controller");
        var options = {
            timeout: 3,
            useSSL: true,
            cleanSession: false,
            onSuccess: onConnect,
            onFailure: onFailure,
            userName: "",
            password: "",
         };
        mqtt.onConnectionLost = onConnectionLost;
        //mqtt.onMessageArrived = onMessageArrived;
        mqtt.onConnected = onConnected;
        mqtt.connect(options);
        //return false;
    }
    
    function send_message(topic,msg) {
        document.getElementById("status_messages").innerHTML ="";
        if (connected_flag==0) {
            out_msg="<b>Error: Not Connected, cannot send message.</b>"
            console.log(out_msg);
            document.getElementById("status_messages").innerHTML = out_msg;
            return false;
        }
        document.getElementById("status_messages").innerHTML="Sending message:  " + msg + " on topic: " + topic;
        message = new Paho.MQTT.Message(msg);
        message.destinationName = topic;
        message.qos = 0;
        message.retained = false;
        mqtt.send(message);
        console.log(msg);
        //return false;
    }

    window.onload = function() {
        MQTTconnect();
    }

    window.onunload = function() {
        disconnect();
        alert("Bye now!");
    }

    document.getElementById("OF").onmouseover = function() {
        this.iid = setInterval(function() { send_message("/hellmut/bb","OF") }, 100);  
    }

    document.getElementById("OF").onmouseout = function() {
        send_message("/hellmut/bb","OO");
        this.iid && clearInterval(this.iid);
    }
    document.getElementById("FF").onmouseover = function() {
        this.iid = setInterval(function() { send_message("/hellmut/bb","FF") }, 100);  
    }

    document.getElementById("FF").onmouseout = function() {
        send_message("/hellmut/bb","OO");
        this.iid && clearInterval(this.iid);
    }
    document.getElementById("FO").onmouseover = function() {
        this.iid = setInterval(function() { send_message("/hellmut/bb","FO") }, 100);  
    }

    document.getElementById("FO").onmouseout = function() {
        send_message("/hellmut/bb","OO");
        this.iid && clearInterval(this.iid);
    }
    document.getElementById("RF").onmouseover = function() {
        this.iid = setInterval(function() { send_message("/hellmut/bb","RF") }, 100);  
    }

    document.getElementById("RF").onmouseout = function() {
        send_message("/hellmut/bb","OO");
        this.iid && clearInterval(this.iid);
    }
    document.getElementById("OO").onmouseover = function() {
        this.iid = setInterval(function() { send_message("/hellmut/bb","OO") }, 100);  
    }

    document.getElementById("OO").onmouseout = function() {
        send_message("/hellmut/bb","OO");
        this.iid && clearInterval(this.iid);
    }
    document.getElementById("FR").onmouseover = function() {
        this.iid = setInterval(function() { send_message("/hellmut/bb","FR") }, 100);  
    }

    document.getElementById("FR").onmouseout = function() {
        send_message("/hellmut/bb","OO");
        this.iid && clearInterval(this.iid);
    }
    document.getElementById("OR").onmouseover = function() {
        this.iid = setInterval(function() { send_message("/hellmut/bb","OR") }, 100);  
    }

    document.getElementById("OR").onmouseout = function() {
        send_message("/hellmut/bb","OO");
        this.iid && clearInterval(this.iid);
    }
    document.getElementById("RR").onmouseover = function() {
        this.iid = setInterval(function() { send_message("/hellmut/bb","RR") }, 100);  
    }

    document.getElementById("RR").onmouseout = function() {
        send_message("/hellmut/bb","OO");
        this.iid && clearInterval(this.iid);
    }
    document.getElementById("RO").onmouseover = function() {
        this.iid = setInterval(function() { send_message("/hellmut/bb","RO") }, 100);  
    }

    document.getElementById("RO").onmouseout = function() {
        send_message("/hellmut/bb","OO");
        this.iid && clearInterval(this.iid);
    }       
    </script>
